<!DOCTYPE html>
<html>
  <head>
  <title>Elegant Text Configuration</title>
  <link rel='stylesheet' type='text/css' href='css/slate.min.css'>
  <script src="http://code.jquery.com/jquery-2.2.0.min.js"></script>
  <script src='js/slate.min.js'></script>
  <style>
  .title {
    padding: 15px 10px;
    text-transform: uppercase;
    font-family: 'PT Sans', sans-serif;
    font-size: 1.2em;
    font-weight: 500;
    color: #888888;
    text-align: center;
  }
  #theme-box .item-button{
    margin-bottom: 25px;
  }
  .u{
    text-decoration: underline;
  }
  </style>
  </head>

  <body>
    <h1 class='title'><span class="u">Elegant Text</span> Configuration<br><br>Watchface Created by <span class="u">Jordan Poles</span> using <span class="u">Slate</span></h1>

    <div class='item-container'>
      <div class='item-container-header'>On Bluetooth Disconnect:</div>
      <div class='item-container-content'>
        <label class='item'>
          Vibrate
          <input id='blt_vibrate' name='blt_vibrate' type='checkbox' class='item-toggle'>
        </label>
      </div>
    </div>
    <div class='item-container'>
      <div class='item-container-header'>United States Weather Settings (By Accuweather):<br></div>
      <div class='item-container-content' style="font-size: .8em; padding: 5px 5px 15px 5px;">
        US ZIP Code:
        <div class="item-input-wrapper">
          <input id='zipcode' name='zipcode' type='text' class='item-input' value="77005">
        </div>
        Weather Refresh Rate (Minutes; 0 to disable weather):
        <div class="item-input-wrapper">
          <input id='weather_refresh_rate' name='weather_refresh_rate' type='text' class='item-input' value="15">
        </div>
        Battery/Weather Switch Rate (Seconds; 0 to disable battery %):
        <div class="item-input-wrapper">
          <input id='weather_swap_rate' name='weather_swap_rate' type='text' class='item-input' value="3">
        </div>
        <i>Weather is a new setting. If you notice an error, please report it to <a href="mailto:jpoles1@gmail.com">jpoles1@gmail.com</a>.</i>
      </div>
    </div>
    <div class='item-container'>
      <div class='item-container-header'>Color Setup:</div>
      <div class='item-container-content'>
        <div class='item'>
          Use this section of the configuration page to choose the colors you would like applied to this watchface.
        </div>
      </div>
    </div>
    <div class='item-container'>
      <div class='item-container-header'>Premade Themes:</div>
      <div class='item-container-content'>
        <div class='item-container'>
          <div class='button-container' id="theme-box">
            <input type='button' class='item-button' value='Classic' onclick="set_theme('classic')">
            <input type='button' class='item-button' value='Cyborg' onclick="set_theme('cyborg')">
            <input type='button' class='item-button' value='Burnt' onclick="set_theme('burnt')">
            <input type='button' class='item-button' value='Aqua (Default)' onclick="set_theme('aqua')">
          </div>
        </div>
      </div>
    </div>
    <div class='item-container'>
      <div class='item-container-header'>Color Schema</div>
      <div class='item-container-content'>
        <label class='item'>
          Background Color
          <input id='background_color' type='text' class='item-color item-color-normal' value='#000000'>
        </label>
      </div>
    </div>

    <div class='item-container'>
      <div class='item-container-content'>
        <label class='item'>
          Text Color
          <input id='text_color' type='text' class='item-color item-color-normal' value='#FFFFFF'>
        </label>
      </div>
    </div>

    <div class='item-container'>
      <div class='item-container-content'>
        <label class='item'>
          Accent Color
          <input id='accent_color' type='text' class='item-color item-color-normal' value='#FFAA00'>
        </label>
      </div>
    </div>
    <div class='item-container'>
      <div class='item-container-header'>Apply Changes:</div>
      <div class='item-container-footer' style="margin-bottom: 10px;">
        <i><b>Note:</b> Due to a current bug, parts of the interface will not update immediately. Just open and close the app menu to fix the colors permanently.</i>
      </div>
      <div class='item-container-content'>
        <div class='item-container'>
          <div class='button-container' id="theme-box">
            <br>
            <input id='submit_button' type='button' class='item-button' value='SUBMIT'>
            <br>
          </div>
        </div>
    </div>
  </div>
    <div class='item-container'>
      <div class='item-container-header'>Get Current Color Values (HEX):</div>
      <div class='item-container-content'>
        <div class='item-container'>
          <div class='button-container' id="theme-box">
            <br>
            <input type='button' class='item-button' value='Get Current Values' onclick="print_conf()">
            <div id="curr_set"></div>
            <br>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
  function getConfigData(save) {
    if(typeof save === "undefined"){
      save = 0;
    }
    var bltVibrate = document.getElementById('blt_vibrate');
    var zipcode = document.getElementById('zipcode');
    var weather_refresh_rate = document.getElementById('weather_refresh_rate');
    var weather_swap_rate = document.getElementById('weather_swap_rate');

    var backgroundColorPicker = document.getElementById('background_color');
    var textColorPicker = document.getElementById('text_color');
    var accentColorPicker = document.getElementById('accent_color');

    var options = {
      'background_color': backgroundColorPicker.value,
      'text_color': textColorPicker.value,
      'accent_color': accentColorPicker.value,
      'weather_refresh_rate': parseInt(weather_refresh_rate.value),
      'weather_swap_rate': parseInt(weather_swap_rate.value),
      'blt_vibrate': bltVibrate.checked,
    };
    //INPUT VALIDATION
    var valid_zipcode = true;
    var zipcode_pattern = /^\d{5}$/
    if(options["weather_refresh_rate"] > 0){
      options['zipcode']= zipcode.value;
      valid_zipcode = zipcode_pattern.test(options["zipcode"]);
    }
    if(options["weather_swap_rate"] == 0 && options["weather_refresh_rate"]==0){
      alert("The weather and swap rates cannot both be set to 0");
    }
    else if(!(options["weather_refresh_rate"]>=0)){
      alert("Please enter a valid refresh rate (a # greater than or equal to 0)")
    }
    else if(!(options["weather_swap_rate"]>=0)){
      alert("Please enter a valid swap rate (a # greater than or equal to 0)")
    }
    else if(!valid_zipcode){
      alert("Invalid zipcode, please try again")
    }
    else{
      console.log('Got options: ' + JSON.stringify(options));
      if(save==1){
        // Save for next launch
        console.log('Saved these options to web storage');
        localStorage.clear();
        for(opt in options){
          localStorage.setItem(opt, options[opt])
        }
      }
      return options
    }
    return false;
  }

  function getQueryParam(variable, defaultValue) {
    var query = location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=');
      if (pair[0] === variable) {
        return decodeURIComponent(pair[1]);
      }
    }
    return defaultValue || false;
  }

  var submitButton = document.getElementById('submit_button');
  submitButton.addEventListener('click', function() {
    console.log('Submit');
    watchface_config = getConfigData(1);
    if(watchface_config!=false){
      // Set the return URL depending on the runtime environment
      var return_to = getQueryParam('return_to', 'pebblejs://close#');
      document.location = return_to + encodeURIComponent(JSON.stringify(watchface_config));
    }
  });
  function set_theme(name){
    var theme = {"classic": {"bg": '0x000000', "txt": '0xFFFFFF', "ac": '0xFFAA00'}, "cyborg": {"bg": '0x550055', "txt": '0xFFFFFF', "ac": '0x55FF00'}, "aqua": {"bg": '0x000000', "txt": '0xFFFFFF', "ac": '0x00FFFF'}, "burnt": {"bg": '0xFFAA00', "txt": '0x000000', "ac": '0x000000'}}
    console.log(name, theme[name])
    var backgroundColorPicker = document.getElementById('background_color');
    var textColorPicker = document.getElementById('text_color');
    var accentColorPicker = document.getElementById('accent_color');
    backgroundColorPicker.value = theme[name]["bg"]
    textColorPicker.value = theme[name]["txt"]
    accentColorPicker.value = theme[name]["ac"]
    $("#background_color + .item-styled-color .value").css("background-color", theme[name]["bg"])
    $("#text_color + .item-styled-color .value").css("background-color", theme[name]["txt"])
    $("#accent_color + .item-styled-color .value").css("background-color", theme[name]["ac"])
    console.log("Set new theme:", theme[name]["bg"], theme[name]["txt"], theme[name]["ac"])
  }
  function print_conf(){
    x = getConfigData()
    $('#curr_set').html("Background: "+x["background_color"]+"; Text: "+x["text_color"]+"; Accent: "+x["accent_color"])
  }
  (function() {
    var bltVibrate = document.getElementById('blt_vibrate');
    var zipcode = document.getElementById('zipcode');
    var weather_refresh_rate = document.getElementById('weather_refresh_rate');
    var weather_swap_rate = document.getElementById('weather_swap_rate');
    var backgroundColorPicker = document.getElementById('background_color');
    var textColorPicker = document.getElementById('text_color');
    var accentColorPicker = document.getElementById('accent_color');
    var options = {
      'background_color': backgroundColorPicker,
      'text_color': textColorPicker,
      'accent_color': accentColorPicker,
      'blt_vibrate': bltVibrate,
      'zipcode': zipcode,
      'weather_refresh_rate': weather_refresh_rate,
      'weather_swap_rate': weather_swap_rate,
    };
    for(opt in options){
      if(localStorage[opt]) {
        options[opt].value = localStorage.getItem(opt);
        options[opt].checked = localStorage.getItem(opt) == "true";
        console.log(opt, localStorage.getItem(opt));
      }
    }
  })();
  </script>
</html>
